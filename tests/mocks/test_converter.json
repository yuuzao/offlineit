{"title": "node \u6a21\u5757\u8f7d\u5165\u539f\u7406\u30101\u3011", "article": "<div id=\"cnblogs_post_body\" class=\"blogpost-body cnblogs-markdown\">\n    <p/><div class=\"toc\"><div class=\"toc-container-header\">\u76ee\u5f55</div><ul><li><a href=\"#\u7b80\u5355\u4ecb\u7ecd\">\u7b80\u5355\u4ecb\u7ecd</a></li><li><a href=\"#c-\u6838\u5fc3\u6a21\u5757\u52a0\u8f7d\u8fc7\u7a0b\">C++ \u6838\u5fc3\u6a21\u5757\u52a0\u8f7d\u8fc7\u7a0b</a><ul><li><a href=\"#\u603b\u7684\u6d41\u7a0b\">\u603b\u7684\u6d41\u7a0b</a></li><li><a href=\"#\u5206\u652f\u4e00\uff1ac-\u6a21\u5757\u6ce8\u518c\u5230\u94fe\u8868\u4e2d\">\u5206\u652f\u4e00\uff1aC++ \u6a21\u5757\u6ce8\u518c\u5230\u94fe\u8868\u4e2d</a><ul><li><a href=\"#1\u3001\u524d\u7f6e\u94fe\u8def\">1\u3001\u524d\u7f6e\u94fe\u8def</a></li><li><a href=\"#2\u3001c-\u6a21\u5757\u6ce8\u518c\u51fd\u6570\u7684\u8c03\u7528\">2\u3001C++ \u6a21\u5757\u6ce8\u518c\u51fd\u6570\u7684\u8c03\u7528</a></li><li><a href=\"#3\u3001c-\u6a21\u5757\u6ce8\u518c\u51fd\u6570\u7684\u5b9a\u4e49\">3\u3001C++ \u6a21\u5757\u6ce8\u518c\u51fd\u6570\u7684\u5b9a\u4e49</a></li></ul></li><li><a href=\"#\u5206\u652f\u4e8c\uff1a\u83b7\u53d6-c-\u6a21\u5757\">\u5206\u652f\u4e8c\uff1a\u83b7\u53d6 C++ \u6a21\u5757</a><ul><li><a href=\"#1\u3001\u524d\u7f6e\u94fe\u8def\">1\u3001\u524d\u7f6e\u94fe\u8def</a></li><li><a href=\"#2\u3001\u4ece\u94fe\u8868\u83b7\u53d6-c-\u6a21\u5757\">2\u3001\u4ece\u94fe\u8868\u83b7\u53d6 C++ \u6a21\u5757</a></li></ul></li></ul></li><li><a href=\"#\u6574\u4f53\u7684\u6d41\u7a0b\u56fe\">\u6574\u4f53\u7684\u6d41\u7a0b\u56fe</a></li><li><a href=\"#\u540e\u7eed\">\u540e\u7eed</a></li><li><a href=\"#\u53c2\u8003\u6587\u6863\">\u53c2\u8003\u6587\u6863</a></li></ul></div>\n<h2 id=\"\u7b80\u5355\u4ecb\u7ecd\">\u7b80\u5355\u4ecb\u7ecd</h2>\n<p>\u6211\u4eec\u4f1a\u4ece\u7b80\u5355\u7684\u6a21\u5757\u8f7d\u5165\u539f\u7406\u6765\u5f00\u59cb\uff0c\u5c1d\u8bd5\u9605\u8bfb\u4e0b Node.js \u6e90\u4ee3\u7801\u3002\u9996\u5148\u6211\u4eec\u77e5\u9053 Node.js \u7684\u6e90\u4ee3\u7801\u4e3b\u8981\u662f\u7531 C++ \u548c JavaScript \u7f16\u5199\u7684\uff0cJS \u90e8\u5206\u4e3b\u8981\u5728 lib \u76ee\u5f55\u4e0b\uff0c\u800c C++ \u90e8\u5206\u4e3b\u8981\u5728 src \u76ee\u5f55\u4e0b\u3002</p>\n<p><img src=\"https://img2020.cnblogs.com/blog/1004427/202003/1004427-20200329151921980-987119585.png\" alt=\"\"/></p>\n<p>\u6a21\u5757\u52a0\u8f7d\u4e3b\u8981\u662f\u5206\u56db\u79cd\u7c7b\u578b\u7684\u6a21\u5757\uff1a</p>\n<ol>\n<li>C++ \u6838\u5fc3\u6a21\u5757\uff1a\u4e3b\u8981\u5728 src \u76ee\u5f55\u4e0b\uff0c\u6bd4\u5982 node_file.cc</li>\n<li>Node.js \u5185\u90e8\u6a21\u5757\uff1a\u548c C++ \u6838\u5fc3\u6a21\u5757\u4e0d\u540c\uff0c\u5728\u6e90\u7801\u7684 lib \u76ee\u5f55\u4e0b\uff0c\u4ee5\u540c\u540d\u7684 JS \u6e90\u7801\u6765\u5b9e\u73b0\uff0c\u5b9e\u9645\u4e0a Node.js \u5185\u7f6e\u6a21\u5757\u662f\u5bf9 C++ \u6838\u5fc3\u6a21\u5757\u7684\u66f4\u9ad8\u5c42\u6b21\u7684\u5c01\u88c5\uff0c\u6bd4\u5982 fs\u3001http</li>\n<li>\u7528\u6237\u6e90\u7801\u6a21\u5757</li>\n<li>C++ \u6269\u5c55\u6a21\u5757\uff1a\u63d2\u4ef6\u662f\u7528 C++ \u7f16\u5199\u7684\u52a8\u6001\u94fe\u63a5\u5171\u4eab\u5bf9\u8c61\u3002 require() \u51fd\u6570\u53ef\u4ee5\u5c06\u63d2\u4ef6\u52a0\u8f7d\u4e3a\u666e\u901a\u7684 Node.js \u6a21\u5757\u3002 \u63d2\u4ef6\u63d0\u4f9b\u4e86 JavaScript \u548c C/C++ \u5e93\u4e4b\u95f4\u7684\u63a5\u53e3\u3002</li>\n</ol>\n<p>\u8fd9\u6b21\u4ecb\u7ecd\u7684\u662f C++ \u6838\u5fc3\u6a21\u5757\u52a0\u8f7d\u7684\u6e90\u7801\u5206\u6790</p>\n<h2 id=\"c-\u6838\u5fc3\u6a21\u5757\u52a0\u8f7d\u8fc7\u7a0b\">C++ \u6838\u5fc3\u6a21\u5757\u52a0\u8f7d\u8fc7\u7a0b</h2>\n<p>\u4e00\u53e5\u8bdd\u6982\u62ec\uff1a\u6bcf\u4e2a C++ \u6838\u5fc3\u6a21\u5757\u6e90\u7801\u672b\u5c3e\u90fd\u6709\u4e00\u4e2a\u5b8f\u8c03\u7528\uff0c\u5c06\u6a21\u5757\u6ce8\u518c\u5230 C++ \u6838\u5fc3\u6a21\u5757\u7684\u94fe\u8868\u5f53\u4e2d\u53bb\uff0c\u4ee5\u4f9b <code>internalBinding</code> \u83b7\u53d6\u5b83\u3002<br/>\n\u4ece\u8fd9\u53e5\u8bdd\u53ef\u4ee5\u5f97\u5230\u4e24\u4e2a\u6b65\u9aa4\uff1a\u6ce8\u518c\u548c\u83b7\u53d6\u3002</p>\n<h3 id=\"\u603b\u7684\u6d41\u7a0b\">\u603b\u7684\u6d41\u7a0b</h3>\n<p><img src=\"https://img2020.cnblogs.com/blog/1004427/202003/1004427-20200329152207598-817500759.png\" alt=\"\"/></p>\n<ol>\n<li>\u5165\u53e3\u6587\u4ef6\u6267\u884c<br/>\n\u6211\u4eec\u77e5\u9053\uff0cNode.js \u7684\u6267\u884c\u5165\u53e3\u5728 node.cc \u7684 Start \u51fd\u6570</li>\n</ol>\n<pre><code class=\"language-c++\">int Start(int argc, char** argv) {}\n</code></pre>\n<ol start=\"2\">\n<li>\u5206\u652f\u4e00\uff1aC++ \u6a21\u5757\u6ce8\u518c\u5230\u94fe\u8868\u4e2d<br/>\n\u6211\u4eec\u6765\u770b\u770b Start \u51fd\u6570\u90fd\u505a\u4e86\u4ec0\u4e48\uff0c\u9996\u5148\u8c03\u7528\u4e86 InitializeOncePerProcess\uff0c\u5bf9 Node.js \u548c V8 \u505a\u521d\u59cb\u5316\u5904\u7406\u3002\u4ece\u8fd9\u4e2a\u51fd\u6570\u627e\u4e0b\u53bb\uff0c\u53ef\u4ee5\u627e\u5230 C++ \u6a21\u5757\u6ce8\u518c\u5230\u94fe\u8868</li>\n</ol>\n<pre><code class=\"language-c++\">InitializationResult result = InitializeOncePerProcess(argc, argv);\n</code></pre>\n<ol start=\"3\">\n<li>\u5206\u652f\u4e8c\uff1a\u83b7\u53d6 C++ \u6a21\u5757<br/>\n\u5728 Start \u51fd\u6570\u7ee7\u7eed\u627e\u4e0b\u53bb\uff0c\u53ef\u4ee5\u770b\u5230\u5b9e\u4f8b\u5316\u4e86 NodeMainInstance\uff0c\u8c03\u7528\u4e86 Run \u51fd\u6570\u3002\u4ece\u8fd9\u4e2a\u51fd\u6570\u627e\u4e0b\u53bb\uff0c\u53ef\u4ee5\u627e\u5230\u83b7\u53d6 C++ \u6a21\u5757\u7684\u8fc7\u7a0b</li>\n</ol>\n<pre><code class=\"language-c++\">NodeMainInstance main_instance(...);\nresult.exit_code = main_instance.Run();\n</code></pre>\n<h3 id=\"\u5206\u652f\u4e00\uff1ac-\u6a21\u5757\u6ce8\u518c\u5230\u94fe\u8868\u4e2d\">\u5206\u652f\u4e00\uff1aC++ \u6a21\u5757\u6ce8\u518c\u5230\u94fe\u8868\u4e2d</h3>\n<p><img src=\"https://img2020.cnblogs.com/blog/1004427/202003/1004427-20200329152336141-625291399.png\" alt=\"\"/></p>\n<h4 id=\"1\u3001\u524d\u7f6e\u94fe\u8def\">1\u3001\u524d\u7f6e\u94fe\u8def</h4>\n<p>\u4ece\u4e0a\u9762\u7684 <code>InitializeOncePerProcess</code> \u5f00\u59cb\u5f80\u4e0b\u627e\uff0c\u53ef\u4ee5\u770b\u5230\u8c03\u7528\u4e86\u521d\u59cb\u5316 node \u7684\u51fd\u6570 <code>InitializeNodeWithArgs</code> \u51fd\u6570</p>\n<pre><code class=\"language-c++\">result.exit_code = InitializeNodeWithArgs(&amp;(result.args), &amp;(result.exec_args), &amp;errors);\n</code></pre>\n<p>\u7ee7\u7eed\u627e\uff0c\u770b\u5230\u5b83\u8c03\u7528\u4e86 node_binding.cc \u4e2d\u7684 <code>RegisterBuiltinModules</code>\uff0c\u4f5c\u7528\u662f\u6ce8\u518c C++ \u6a21\u5757</p>\n<pre><code class=\"language-c++\">binding::RegisterBuiltinModules();\n</code></pre>\n<h4 id=\"2\u3001c-\u6a21\u5757\u6ce8\u518c\u51fd\u6570\u7684\u8c03\u7528\">2\u3001C++ \u6a21\u5757\u6ce8\u518c\u51fd\u6570\u7684\u8c03\u7528</h4>\n<p>\u90a3\u6211\u4eec\u5c31\u6765\u770b\u4e00\u4e0b\uff0c<code>RegisterBuiltinModules</code> \u8fd9\u4e2a\u51fd\u6570\u90fd\u505a\u4e86\u4ec0\u4e48\uff0c\u4e3b\u8981\u505a\u4e86\u4e24\u4ef6\u4e8b\uff1a\u4e00\u662f\u5b9a\u4e49\u4e86 <code>V</code> \u8fd9\u4e2a\u5b8f\uff0c\u5b83\u63a5\u6536 <code>modname</code> \u8fd9\u4e2a\u53c2\u6570\uff1b\u4e8c\u662f\u8c03\u7528 <code>NODE_BUILTIN_MODULES</code></p>\n<pre><code class=\"language-c++\">void RegisterBuiltinModules() {\n#define V(modname) _register_##modname();\nNODE_BUILTIN_MODULES(V)  // module name \u53ef\u4ee5\u5728\u8fd9\u4e2a\u5b8f\u627e\u5230\uff0c\u8fd9\u91cc\u4e0d\u591a\u5199\u4e86\n#undef V\n}\n</code></pre>\n<p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>NODE_BUILTIN_MODULES</code> \u5176\u5b9e\u4e5f\u662f\u4e00\u4e2a\u5b8f\u5b9a\u4e49\uff1a</p>\n<pre><code class=\"language-c++\">#define NODE_BUILTIN_MODULES(V)                                          \\   NODE_BUILTIN_STANDARD_MODULES(V)                                         \\   \n...\n</code></pre>\n<p>\u5176\u4e2d <code>NODE_BUILTIN_STANDARD_MODULES</code> \u7684\u5b9a\u4e49\u662f\u8fd9\u6837\u7684\uff1a</p>\n<pre><code class=\"language-c++\">#define NODE_BUILTIN_STANDARD_MODULES(V)                                 \\\n  V(async_wrap)                                                          \\\n  V(buffer)                                                              \\\n  ...\n</code></pre>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0cc++\u7684\u9884\u5904\u7406\u540e\uff0c\u4f1a\u53d8\u6210\u4e0b\u9762\u7684\u51fd\u6570\u4f53</p>\n<pre><code class=\"language-c++\">void RegisterBuiltinModules() {  \n  _register_async_wrap();  \n  _register_buffer();  \n.... }\n</code></pre>\n<p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u6700\u7ec8\u53bb\u8c03\u7528\u7684\u662f <code>_register_async_wrap</code> \u548c <code>_register_buffer</code> ...\u8fd9\u4e9b\u51fd\u6570\uff0c\u597d\u4e86\uff0c\u90a3\u4e48\u8fd9\u4e9b\u51fd\u6570\u662f\u5728\u54ea\u5b9a\u4e49\u7684\u5462\uff1f</p>\n<h4 id=\"3\u3001c-\u6a21\u5757\u6ce8\u518c\u51fd\u6570\u7684\u5b9a\u4e49\">3\u3001C++ \u6a21\u5757\u6ce8\u518c\u51fd\u6570\u7684\u5b9a\u4e49</h4>\n<p>\u4ece\u4e0a\u9762\u5b8f\u5b9a\u4e49\u540e\u9762\uff0c\u53ef\u4ee5\u627e\u5230\u8fd9\u6837\u7684\u6ce8\u91ca\uff1a<br/>\nThe definitions are in each module's implementation when calling the NODE_MODULE_CONTEXT_AWARE_INTERNAL.<br/>\n\u4e5f\u5c31\u662f\u8bf4\uff0c\u5b9a\u4e49\u662f\u5728\u6bcf\u4e2a\u6a21\u5757\u8c03\u7528 <code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code> \u65f6\u8fdb\u884c\u7684\uff5e</p>\n<p>\u597d\u7684\u4e8e\u662f\u6211\u4eec\u770b\u770b fs \u6a21\u5757\u5bf9\u5e94\u7684 C++ \u6587\u4ef6 node_file.cc \uff0c\u770b\u5230\u6700\u540e\u4e00\u884c\u8c03\u7528\u4e86 <code>NODE_MODULE_CONTEXT_AWARE_INTERNAL</code></p>\n<pre><code class=\"language-c++\">NODE_MODULE_CONTEXT_AWARE_INTERNAL(fs, node::fs::Initialize)\n</code></pre>\n<p>\u7ee7\u7eed\uff0c\u5728 node_binding.h \u770b\u5230\u5b83\u8c03\u7528\u4e86 <code>NODE_MODULE_CONTEXT_AWARE_CPP</code></p>\n<pre><code class=\"language-c++\">#define NODE_MODULE_CONTEXT_AWARE_INTERNAL(modname, regfunc)             \\\n  NODE_MODULE_CONTEXT_AWARE_CPP(modname, regfunc, nullptr, NM_F_INTERNAL)\n</code></pre>\n<p>\u7ee7\u7eed\uff0c\u5728 node_binding.h \u4e2d\uff0c\u5b9a\u4e49\u4e86<code> _register_##modname</code> \u6267\u884c\u65f6\u8c03\u7528\u4e86 <code>node_module_register</code></p>\n<pre><code class=\"language-c++\">#define NODE_MODULE_CONTEXT_AWARE_CPP(modname, regfunc, priv, flags)    \\ \n  void _register_##modname() { node_module_register(&amp;_module); }\n</code></pre>\n<p>\u597d\u7684\u6700\u540e\u4e00\u6b65\uff0c\u5728 node_binding.cc \u4e2d\u627e\u5230\u4e86\u5b83\u7684\u5b9a\u4e49\uff0c\u5c06\u4f20\u5165\u7684 node module \u63d2\u5230\u4e86\u94fe\u8868 <code>modlist_internal</code> \u4e2d\uff0c\u540e\u9762\u67e5\u627e\u65f6\u5c31\u4f1a\u5728\u8fd9\u91cc\u627e\u4e86\uff5e</p>\n<pre><code class=\"language-c++\">extern \"C\" void node_module_register(void* m) {\n  struct node_module* mp = reinterpret_cast&lt;struct node_module*&gt;(m);\n  if (mp-&gt;nm_flags &amp; NM_F_INTERNAL) {\n    mp-&gt;nm_link = modlist_internal;\n    modlist_internal = mp;\n  }\n}\n</code></pre>\n<p>\u597d\u4e86\uff5e\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u77e5\u9053\uff0cC++ \u6a21\u5757\u7684\u63d2\u5165\u94fe\u8868\u7684\u8fc7\u7a0b\u4e86\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\uff1a\u6bcf\u4e2a C++ \u5185\u7f6e\u6a21\u5757\u6e90\u7801\u672b\u5c3e\u90fd\u6709\u4e00\u4e2a\u5b8f\u8c03\u7528\uff0c\u7f16\u8bd1\u6a21\u5757\u4ee3\u7801\u7684\u65f6\u5019\uff0c\u5c06\u6a21\u5757\u6ce8\u518c\u5230 C++ \u6838\u5fc3\u6a21\u5757\u7684\u94fe\u8868 <code>modlist_internal</code> \u5f53\u4e2d\u53bb\uff0c\u8bb0\u4f4f\u94fe\u8868\u7684\u540d\u5b57\u54e6\u3002</p>\n<h3 id=\"\u5206\u652f\u4e8c\uff1a\u83b7\u53d6-c-\u6a21\u5757\">\u5206\u652f\u4e8c\uff1a\u83b7\u53d6 C++ \u6a21\u5757</h3>\n<p><img src=\"https://img2020.cnblogs.com/blog/1004427/202003/1004427-20200329152917865-971867641.png\" alt=\"\"/></p>\n<h4 id=\"1\u3001\u524d\u7f6e\u94fe\u8def-2\">1\u3001\u524d\u7f6e\u94fe\u8def</h4>\n<p>\u597d\uff0c\u8fd9\u90e8\u5206\u4ece <code>main_instance.Run()</code> \u5f00\u59cb\uff0c\u53ef\u4ee5\u770b\u5230\u4ed6\u7684\u5b9a\u4e49\u5728 node_main_instance.cc \u91cc\u9762<br/>\n\u6267\u884c\u4e86 <code>RunBootstrapping</code></p>\n<pre><code class=\"language-c++\">if (env-&gt;RunBootstrapping().IsEmpty()) {\n  *exit_code = 1;\n}\n</code></pre>\n<p><code>RunBootstrapping</code> \u6267\u884c\u4e86 node.cc \u4e2d\u7684 <code>BootstrapInternalLoaders</code></p>\n<pre><code class=\"language-c++\">if (BootstrapInternalLoaders().IsEmpty()) {\n  return MaybeLocal&lt;Value&gt;();\n}\n</code></pre>\n<p>\u63a5\u7740\u5b83\u6267\u884c\u4e86 internal/bootstrap/loaders \u8fd9\u4e2a\u6587\u4ef6</p>\n<pre><code class=\"language-c++\">if (!ExecuteBootstrapper(this, \"internal/bootstrap/loaders\", &amp;loaders_params, &amp;loaders_args).ToLocal(&amp;loader_exports))\n</code></pre>\n<h4 id=\"2\u3001\u4ece\u94fe\u8868\u83b7\u53d6-c-\u6a21\u5757\">2\u3001\u4ece\u94fe\u8868\u83b7\u53d6 C++ \u6a21\u5757</h4>\n<p>\u5728\u8fd9\u4e2a\u6587\u4ef6\u7684\u6ce8\u91ca\u4e2d\uff0c\u89e3\u91ca\u4e86\u5b83\u7684\u4f5c\u7528\uff1a<br/>\nThis file is compiled as if it's wrapped in a function with arguments passed by node::RunBootstrapping()<br/>\nglobal process, getLinkedBinding, getInternalBinding, primordials<br/>\n\u53ef\u4ee5\u770b\u51fa\u8fd9\u4e2a js \u6587\u4ef6\u88ab\u5305\u88f9\u5728\u4e00\u4e2a\u51fd\u6570\u4e2d\uff0c\u8fd9\u4e2a\u51fd\u6570\u63a5\u6536\u56db\u4e2a\u53c2\u6570\uff0c\u8fd9\u56db\u4e2a\u53c2\u6570\u54ea\u91cc\u6765\u7684\u5462<br/>\n\u518d\u53bb C++ \u6587\u4ef6\u91cc\u627e</p>\n<pre><code class=\"language-c++\">// Create binding loaders\n  std::vector&lt;Local&lt;String&gt;&gt; loaders_params = {\n      process_string(),\n      FIXED_ONE_BYTE_STRING(isolate_, \"getLinkedBinding\"),\n      FIXED_ONE_BYTE_STRING(isolate_, \"getInternalBinding\"),\n      primordials_string()};\n  std::vector&lt;Local&lt;Value&gt;&gt; loaders_args = {\n      process_object(),\n      NewFunctionTemplate(binding::GetLinkedBinding)\n      NewFunctionTemplate(binding::GetInternalBinding)\n      primordials()};\n</code></pre>\n<p>\u55ef\uff0c\u5176\u4e2d <code>getLinkedBinding</code> \u548c <code>getInternalBinding</code> \u4e24\u4e2a\u51fd\u6570\uff0c\u5b83\u4eec\u4f1a\u8d1f\u8d23 JS \u548c C++ \u7684\u4ea4\u4e92\uff0c<code>getInternalBinding</code> \u662f\u83b7\u53d6\u6838\u5fc3\u6a21\u5757\u7684\u51fd\u6570\uff0c\u53e6\u5916\u7684\u4e00\u4e2a\u5e94\u8be5\u662f C++ \u6269\u5c55\u76f8\u5173\u7684\uff0c\u90a3\u6211\u4eec\u6765\u770b\u4e0b <code>GetInternalBinding</code><br/>\n\u5728 node_binding.cc \u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u5b83\u5185\u90e8\u6267\u884c\u4e86 <code>get_internal_module</code></p>\n<pre><code class=\"language-c++\">node_module* mod = get_internal_module(*module_v);\n</code></pre>\n<p>\u6765\uff5enode_binding.cc \u91cc\u9762\u7684 <code>get_internal_module</code> \u53bb\u6267\u884c\u4e86 <code>FindModule</code> \u4f20\u5165\u4e86\u521a\u624d\u6211\u4eec\u6ce8\u518c\u4e86\u7684\u94fe\u8868 <code>modlist_internal</code>\uff0c\u6a21\u5757\u6807\u8bc6\uff0c\u548c\u6807\u8bc6\u5185\u90e8\u6a21\u5757\u7684\u4e00\u4e2a\u5e38\u91cf</p>\n<pre><code class=\"language-c++\">node_module* get_internal_module(const char* name) {\n  return FindModule(modlist_internal, name, NM_F_INTERNAL);\n}\n</code></pre>\n<p>\u6700\u540e\u6211\u4eec\u770b\u770b <code>FindModule</code></p>\n<pre><code class=\"language-c++\">inline struct node_module* FindModule(struct node_module* list,\n                                      const char* name,\n                                      int flag) {\n  struct node_module* mp;\n  for (mp = list; mp != nullptr; mp = mp-&gt;nm_link) {\n    if (strcmp(mp-&gt;nm_modname, name) == 0) break;\n  }\n  CHECK(mp == nullptr || (mp-&gt;nm_flags &amp; flag) != 0);\n  return mp;\n}\n</code></pre>\n<p>\u55ef\uff0c\u4ece <code>modlist_internal</code> \u94fe\u8868\u4e2d\u627e\u5230\u6a21\u5757\u5e76\u8fd4\u56de\u4e86\uff0c\u8036</p>\n<h2 id=\"\u6574\u4f53\u7684\u6d41\u7a0b\u56fe\">\u6574\u4f53\u7684\u6d41\u7a0b\u56fe</h2>\n<p><img src=\"https://img2020.cnblogs.com/blog/1004427/202003/1004427-20200329153245274-773682225.png\" alt=\"\"/></p>\n<h2 id=\"\u540e\u7eed\">\u540e\u7eed</h2>\n<p>\u6700\u540e\u8bf4\u5230 loader.js \u63a5\u6536\u5230 <code>getInternalBinding</code> \u5c31\u505c\u6b62\u4e86\uff0c\u90a3\u5728\u7ee7\u7eed\u770b\u4e00\u4e0b\uff0c\u4ed6\u5b9a\u4e49\u4e86 <code>process.binding</code> \u548c <code>process._linkedBinding</code> \u5206\u522b\u5bf9\u5e94\u521a\u624d\u7684 <code>getInternalBinding</code> \u548c <code>getLinkedBinding</code>\uff0c\u53e6\u5916\u8fd8\u5b9a\u4e49\u4e86 <code>internalBinding</code></p>\n<pre><code class=\"language-js\">internalBinding = function internalBinding(module) {\n    let mod = bindingObj[module];\n    if (typeof mod !== 'object') {\n      mod = bindingObj[module] = getInternalBinding(module);\n      moduleLoadList.push(`Internal Binding ${module}`);\n    }\n    return mod;\n  };\n</code></pre>\n<p>\u8fd9\u4e2a\u51fd\u6570\u7528\u5230\u7684\u5730\u65b9\u5f88\u591a\uff0c\u6bd4\u5982\u5728 fs.js \u4e2d\uff0c\u6216\u662f\u901a\u8fc7 CommonJS \u6216 ESModule \u7684\u65b9\u5f0f\u52a0\u8f7d JS \u6a21\u5757\u65f6\uff0c\u4e5f\u4f1a\u7528\u5230\u8fd9\u4e2a\u51fd\u6570\uff0c\u540e\u9762\u8fd8\u6709\u5f88\u591a\u53ef\u4ee5\u770b\uff5e</p>\n<h2 id=\"\u53c2\u8003\u6587\u6863\">\u53c2\u8003\u6587\u6863</h2>\n<ul>\n<li><a href=\"https://juejin.im/post/5d10b607e51d45108f254229\">https://juejin.im/post/5d10b607e51d45108f254229</a></li>\n<li><a href=\"https://www.zhihu.com/lives/842742839304667136\">https://www.zhihu.com/lives/842742839304667136</a></li>\n<li><a href=\"https://dev.to/captainsafia/how-does-node-load-built-in-modules-g1k\">https://dev.to/captainsafia/how-does-node-load-built-in-modules-g1k</a></li>\n<li><a href=\"https://github.com/tsy77/blog/issues/7\">https://github.com/tsy77/blog/issues/7</a></li>\n</ul>\n\n</div>\n", "date": "2020-03-29 15:35"}